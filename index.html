<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventario Etiquetas</title>

  <style>
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      margin: 0;
      background: #f3f4f6;
      color: #111827;
    }

    .page { max-width: 1200px; margin: 24px auto 40px; padding: 0 16px; }

    .card {
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,.08), 0 4px 6px -4px rgba(0,0,0,.05);
      padding: 18px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 14px;
    }

    .title-block h1 { margin: 0; font-size: 24px; font-weight: 700; }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #dbeafe;
      white-space: nowrap;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .toolbar-group { display: flex; flex-direction: column; gap: 4px; }

    label { font-size: 12px; font-weight: 600; color: #4b5563; }

    select, input, textarea, button {
      font-size: 14px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 10px 12px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
      background: #fff;
    }

    select:focus, input:focus, textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
    }

    button {
      cursor: pointer;
      border: none;
      font-weight: 700;
      padding-inline: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
      border-radius: 12px;
      padding-block: 12px;
    }

    #btnCargar  { background: #2563eb; color: #ffffff; }
    #btnGuardar { background: #16a34a; color: #ffffff; }
    #btnImprimir{ background: #6b7280; color: #ffffff; }
    button:disabled { opacity: 0.55; cursor: not-allowed; }

    .hint { font-size: 11px; color: #6b7280; margin-top: 2px; }

    #status {
      font-size: 13px;
      min-height: 18px;
      color: #4b5563;
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 220px;
    }

    .status-dot { width: 8px; height: 8px; border-radius: 999px; background: #9ca3af; }
    #status.ok { color: #16a34a; }   #status.ok .status-dot { background: #22c55e; }
    #status.err{ color: #b91c1c; }   #status.err .status-dot{ background: #ef4444; }
    #status.info{color:#4b5563;}     #status.info .status-dot{ background:#9ca3af; }

    /* ====== TABLA (Desktop) ====== */
    .table-shell {
      margin-top: 12px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
      background: #ffffff;
    }

    .table-wrapper { max-height: 60vh; overflow: auto; }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
      table-layout: fixed;
    }

    th, td {
      padding: 8px 8px;
      border-bottom: 1px solid #d1d5db;
      border-right: 1px solid #94a3b8;
      vertical-align: top;
      background-clip: padding-box;
    }

    thead th:last-child, tbody td:last-child { border-right: none; }

    th {
      position: sticky;
      top: 0;
      z-index: 1;
      background: #f9fafb;
      text-align: left;
      font-size: 12px;
      font-weight: 800;
      color: #1f2937;
      border-bottom: 2px solid #94a3b8;
    }

    tbody tr:nth-child(odd)  td { background: #ffffff; }
    tbody tr:nth-child(even) td { background: #f9fafb; }

    td.col-codigo {
      white-space: nowrap;
      word-break: normal;
      font-variant-numeric: tabular-nums;
    }

    td.col-desc {
      white-space: normal;
      word-break: break-word;
      font-size: 10px;
      line-height: 1.25;
    }

    input[type="number"] { width: 100%; text-align: right; }

    .motivo-input {
      width: 100%;
      max-width: 150px;
      padding: 8px 10px;
      font-size: 12px;
      border-radius: 10px;
    }

    textarea {
      width: 100%;
      height: 28px;
      min-height: 28px;
      resize: vertical;
      padding: 8px 10px;
      font-size: 13px;
      line-height: 1.2;
      border-radius: 10px;
    }

    .summary {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-top: 1px solid #e5e7eb;
      font-size: 12px;
      color: #4b5563;
      background: #f9fafb;
    }

    .summary strong { font-weight: 800; color: #111827; }

    /* ====== MOBILE UX: CARDS ====== */
    .mobile-list { display: none; margin-top: 12px; }
    .mobile-card {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      background: #fff;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: 0 6px 12px -8px rgba(0,0,0,.15);
    }
    .mc-head {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .mc-code {
      font-weight: 900;
      letter-spacing: .2px;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }
    .mc-desc {
      font-size: 12px;
      color: #374151;
      line-height: 1.25;
      margin-top: 4px;
      word-break: break-word;
    }
    .mc-meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }
    .pill {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 8px 10px;
      background: #f9fafb;
      font-size: 12px;
      color: #374151;
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .pill strong { font-weight: 900; color: #111827; }
    .mc-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .field label {
      display: block;
      font-size: 11px;
      font-weight: 800;
      color: #4b5563;
      margin-bottom: 6px;
    }
    .field input, .field textarea, .field select {
      width: 100%;
      border-radius: 14px;
      padding: 12px;
      font-size: 16px; /* clave: evita zoom raro iOS */
    }
    .field textarea { min-height: 44px; height: 44px; }
    .mc-bottom {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    /* Barra fija inferior en mobile para ‚ÄúGuardar‚Äù sin scrollear */
    .mobile-actionbar {
      display: none;
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 12px;
      background: rgba(243,244,246,.92);
      backdrop-filter: blur(8px);
      border-top: 1px solid #e5e7eb;
      z-index: 50;
    }
    .mobile-actionbar .inner {
      max-width: 900px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 0 10px;
    }

    @media (max-width: 768px) {
      .header { flex-direction: column; align-items: flex-start; }
      .toolbar { flex-direction: column; align-items: stretch; }
      button { width: 100%; }
      #status { min-width: unset; }

      /* en mobile oculto tabla y muestro cards */
      .table-shell { display: none; }
      .mobile-list { display: block; }
      .mobile-actionbar { display: block; }

      /* deja espacio para la barra fija */
      .page { padding-bottom: 84px; }
    }

    /* ---- PRINT HEADER (solo impresi√≥n) ---- */
    .print-header { display: none; }
    @media print {
      @page { size: A4 landscape; margin: 5mm; }

      body { background: #ffffff; }
      .no-print { display: none !important; }
      .page { margin: 0; max-width: 100%; padding: 0; }
      .card { box-shadow: none; border-radius: 0; padding: 0; }
      .table-shell { display: block; border-radius: 0; border: none; }
      .mobile-list { display: none !important; }
      .mobile-actionbar { display: none !important; }

      .print-header {
        display: flex !important;
        justify-content: space-between;
        align-items: baseline;
        margin: 0 0 6px 0;
        padding: 0 0 4px 0;
        border-bottom: 2px solid #000;
      }
      .print-title { font-size: 16px; font-weight: 800; }
      .print-meta  { font-size: 11px; }

      .table-wrapper{
        max-height: none !important;
        height: auto !important;
        overflow: visible !important;
      }
      th { position: static !important; }

      table { font-size: 10px; table-layout: fixed; }
      th, td { padding: 5px 6px; }
      tr { break-inside: avoid; page-break-inside: avoid; }

      textarea { height: 40px; min-height: 40px; }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="card">
      <div class="header no-print">
        <div class="title-block"><h1>Inventario Etiquetas</h1></div>
        <div class="badge">Paso 1: cargar listado ¬∑ Paso 2: contar ¬∑ Paso 3: guardar</div>
      </div>

      <div class="toolbar no-print">
        <div class="toolbar-group">
          <label for="responsable">Responsable del conteo</label>
          <select id="responsable"></select>
          <div class="hint">Eleg√≠ tu abreviatura y luego carg√° tus insumos.</div>
        </div>

        <div class="toolbar-group">
          <label>&nbsp;</label>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button id="btnCargar">üì• Cargar mis insumos</button>
            <button id="btnGuardar" disabled>üíæ Guardar conteos</button>
            <button id="btnImprimir">üñ®Ô∏è Imprimir listado</button>
          </div>
        </div>

        <div id="status" class="info">
          <span class="status-dot"></span><span>Preparado para empezar.</span>
        </div>
      </div>

      <!-- Encabezado SOLO para impresi√≥n -->
      <div class="print-header">
        <div class="print-title">Inventario Etiquetas</div>
        <div class="print-meta">Responsable: <strong id="print-responsable">‚Äî</strong></div>
      </div>

      <!-- MOBILE: cards -->
      <div id="mobileList" class="mobile-list"></div>

      <!-- DESKTOP: tabla -->
      <div class="table-shell">
        <div class="table-wrapper">
          <table id="tabla">
            <colgroup>
              <col style="width: 130px;">
              <col style="width: 190px;">
              <col style="width: 80px;">
              <col style="width: 80px;">
              <col style="width: 90px;">
              <col style="width: 120px;">
              <col style="width: 120px;">
              <col style="width: 100px;">
              <col style="width: 170px;">
            </colgroup>

            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Descripci√≥n</th>
                <th>Stock 1030</th>
                <th>Stock 1032</th>
                <th>D√≠a stock</th>
                <th>Stock 1030 ACTUAL</th>
                <th>Conteo f√≠sico</th>
                <th>Motivo</th>
                <th>Observaciones</th>
              </tr>
            </thead>

            <tbody></tbody>
          </table>
        </div>

        <div class="summary no-print">
          <div>
            <strong id="totalInsumos">0</strong> insumos cargados ¬∑
            <strong id="totalCompletados">0</strong> con conteo cargado
          </div>
          <div class="hint">Consejo: complet√° solo las filas que realmente contaste.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- barra fija mobile -->
  <div class="mobile-actionbar no-print">
    <div class="inner">
      <button id="btnCargarMobile" style="background:#2563eb;color:#fff;">üì• Cargar</button>
      <button id="btnGuardarMobile" style="background:#16a34a;color:#fff;" disabled>üíæ Guardar</button>
    </div>
  </div>

<script>
  // ====== CONFIG: URLs de Flows ======
  const URL_PLAN =
    "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/59b0d1d8c50c4277b875cb90c744d925/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=nTWG-VHLTpxBq_lVT8BwliveH9lxEFEcFhRisJDhd_g";

  const URL_GUARDAR =
    "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/db8f32640e3342199cad89ba5beca1a5/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=r_Y84605bC4pYKqpBNnQywaD3Qf5bY-jvVVBftQvkdU";

  const RESPONSABLES_FIJOS = ["JQ", "CG", "DF", "MF", "LS", "NM", "PM"];

  const $ = id => document.getElementById(id);
  const tbody = document.querySelector("#tabla tbody");
  const mobileList = $("mobileList");

  let motivoGlobal = "Semanal";

  // Guardamos referencias por fila para sincronizar Table <-> Mobile
  // rowStore[rowId] = { ...refs }
  const rowStore = Object.create(null);

  function isMobileView() {
    return window.matchMedia("(max-width: 768px)").matches;
  }

  function syncPrintResponsable() {
    const sel = $("responsable");
    const out = $("print-responsable");
    if (!sel || !out) return;
    out.textContent = sel.value || "‚Äî";
  }

  function setStatus(msg, type = "info") {
    const el = $("status");
    if (!el) return;
    el.className = type;
    el.innerHTML = `<span class="status-dot"></span><span>${msg}</span>`;
  }

  function escapeHtml(str) {
    return String(str ?? "").replace(/[&<>"']/g, s =>
      ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[s])
    );
  }

  function formatearDia(valor) {
    if (valor == null || valor === "") return "";

    if (/^\d{2}\/\d{2}\/\d{4}/.test(String(valor))) return String(valor);

    if (typeof valor === "number" || /^[0-9]+(\.[0-9]+)?$/.test(String(valor))) {
      const serial = Number(valor);
      if (!Number.isFinite(serial)) return String(valor);

      const days = Math.floor(serial);
      const frac = serial - days;

      const base = new Date(1899, 11, 30);
      base.setDate(base.getDate() + days);

      const minutesTotal = Math.round(frac * 24 * 60);
      const hours   = String(Math.floor(minutesTotal / 60)).padStart(2, "0");
      const minutes = String(minutesTotal % 60).padStart(2, "0");

      const year  = base.getFullYear();
      const month = String(base.getMonth() + 1).padStart(2, "0");
      const day   = String(base.getDate()).padStart(2, "0");

      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    const d = new Date(valor);
    if (!isNaN(d.getTime())) {
      const year  = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day   = String(d.getDate()).padStart(2, "0");
      const hours = String(d.getHours()).padStart(2, "0");
      const mins  = String(d.getMinutes()).padStart(2, "0");
      return `${day}/${month}/${year} ${hours}:${mins}`;
    }

    return String(valor);
  }

  async function apiPost(url, body) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify(body)
    });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = text; }
    if (!res.ok) throw new Error(typeof data === "string" ? data : JSON.stringify(data));
    return data;
  }

  function actualizarResumen() {
    const filas = Object.values(rowStore);
    $("totalInsumos").textContent = filas.length;

    let completados = 0;
    for (const r of filas) {
      const v = (r.inputConteoMobile?.value ?? r.inputConteoTable?.value ?? "").trim();
      if (v !== "") completados++;
    }
    $("totalCompletados").textContent = completados;
  }

  function setGuardarEnabled(on) {
    $("btnGuardar").disabled = !on;
    $("btnGuardarMobile").disabled = !on;
  }

  function aplicarMotivoATodasLasFilas(nuevoMotivo) {
    motivoGlobal = nuevoMotivo;

    for (const r of Object.values(rowStore)) {
      if (r.selMotivoFirstTable) r.selMotivoFirstTable.value = motivoGlobal;
      if (r.selMotivoFirstMobile) r.selMotivoFirstMobile.value = motivoGlobal;

      if (r.motivoReadonlyTable) r.motivoReadonlyTable.value = motivoGlobal;
      if (r.motivoReadonlyMobile) r.motivoReadonlyMobile.value = motivoGlobal;
    }
  }

  function getFirstExisting(obj, keys) {
    for (const k of keys) {
      if (obj && obj[k] != null && obj[k] !== "") return obj[k];
    }
    return "";
  }

  function linkTwoInputs(a, b, onChange) {
    if (!a || !b) return;
    const sync = (src, dst) => {
      dst.value = src.value;
      if (onChange) onChange();
    };
    a.addEventListener("input", () => sync(a, b));
    b.addEventListener("input", () => sync(b, a));
  }

  function crearFilaTabla(item, idx, rowId) {
    const codigo = getFirstExisting(item, ["codigo","C√≥digo","CODIGO","Code"]);
    const descripcion = getFirstExisting(item, [
      "descripcion","descripci√≥n","Descripcion","Descripci√≥n","DESCRIPCION","DESCRIPCI√ìN","desc","Desc"
    ]);
    const stock1030 = getFirstExisting(item, ["stock1030","Stock1030","STOCK1030","Stock 1030","stockJDE"]);
    const stock1032 = getFirstExisting(item, ["stock1032","Stock1032","STOCK1032","Stock 1032"]);
    const diaMostrar = formatearDia(getFirstExisting(item, ["dia","DIA","fecha","Fecha","Dia stock","D√≠a stock"]));

    const tr = document.createElement("tr");

    const motivoCell = (idx === 0)
      ? `
        <select class="motivo-input" data-role="motivo-first-table">
          <option value="Semanal">Semanal</option>
          <option value="Administraci√≥n">Administraci√≥n</option>
        </select>`
      : `<input class="motivo-input" data-role="motivo-readonly-table" type="text" readonly value="${escapeHtml(motivoGlobal)}" />`;

    tr.innerHTML = `
      <td class="col-codigo">${escapeHtml(codigo)}</td>
      <td class="col-desc">${escapeHtml(descripcion)}</td>
      <td style="text-align:right;">${escapeHtml(stock1030)}</td>
      <td style="text-align:right;">${escapeHtml(stock1032)}</td>
      <td style="font-size:11px;">${escapeHtml(diaMostrar)}</td>
      <td><input type="number" min="0" step="1" placeholder="" data-field="stock1030_actual_table" /></td>
      <td><input type="number" min="0" step="1" placeholder="" data-field="conteo_table" /></td>
      <td>${motivoCell}</td>
      <td><textarea placeholder=""></textarea></td>
    `;

    tr.dataset.rowId = rowId;
    tr.dataset.codigo = codigo;
    tr.dataset.descripcion = descripcion;
    tr.dataset.stock1030 = stock1030 ?? 0;
    tr.dataset.stock1032 = stock1032 ?? 0;
    tr.dataset.dia = diaMostrar;

    const inputStockAct = tr.querySelector('input[data-field="stock1030_actual_table"]');
    const inputConteo   = tr.querySelector('input[data-field="conteo_table"]');
    const txtObs        = tr.querySelector("textarea");

    inputConteo.addEventListener("input", actualizarResumen);

    let selMotivoFirst = null;
    let motivoReadonly = null;
    if (idx === 0) {
      selMotivoFirst = tr.querySelector('select[data-role="motivo-first-table"]');
      selMotivoFirst.value = motivoGlobal;
      selMotivoFirst.addEventListener("change", () => aplicarMotivoATodasLasFilas(selMotivoFirst.value));
    } else {
      motivoReadonly = tr.querySelector('input[data-role="motivo-readonly-table"]');
    }

    return { tr, codigo, descripcion, stock1030, stock1032, diaMostrar, inputStockAct, inputConteo, txtObs, selMotivoFirst, motivoReadonly };
  }

  function crearCardMobile(item, idx, rowId, base) {
    const el = document.createElement("div");
    el.className = "mobile-card";
    el.dataset.rowId = rowId;

    const motivoUI = (idx === 0)
      ? `
        <div class="field">
          <label>Motivo (aplica a todos)</label>
          <select data-role="motivo-first-mobile">
            <option value="Semanal">Semanal</option>
            <option value="Administraci√≥n">Administraci√≥n</option>
          </select>
        </div>`
      : `
        <div class="field">
          <label>Motivo (copiado)</label>
          <input type="text" readonly data-role="motivo-readonly-mobile" value="${escapeHtml(motivoGlobal)}" />
        </div>`;

    el.innerHTML = `
      <div class="mc-head">
        <div>
          <div class="mc-code">${escapeHtml(base.codigo)}</div>
          <div class="mc-desc">${escapeHtml(base.descripcion)}</div>
        </div>
      </div>

      <div class="mc-meta">
        <div class="pill"><span>Stock 1030</span><strong>${escapeHtml(base.stock1030)}</strong></div>
        <div class="pill"><span>Stock 1032</span><strong>${escapeHtml(base.stock1032)}</strong></div>
        <div class="pill" style="grid-column:1/-1;">
          <span>D√≠a stock</span><strong style="font-size:12px;">${escapeHtml(base.diaMostrar)}</strong>
        </div>
      </div>

      <div class="mc-grid">
        <div class="field">
          <label>Stock 1030 ACTUAL</label>
          <input type="number" min="0" step="1" inputmode="numeric" data-field="stock1030_actual_mobile" placeholder="" />
        </div>
        <div class="field">
          <label>Conteo f√≠sico</label>
          <input type="number" min="0" step="1" inputmode="numeric" data-field="conteo_mobile" placeholder="" />
        </div>
      </div>

      <div class="mc-bottom">
        ${motivoUI}
        <div class="field">
          <label>Observaciones</label>
          <textarea data-field="obs_mobile" placeholder=""></textarea>
        </div>
      </div>
    `;

    const inputStockAct = el.querySelector('input[data-field="stock1030_actual_mobile"]');
    const inputConteo   = el.querySelector('input[data-field="conteo_mobile"]');
    const txtObs        = el.querySelector('textarea[data-field="obs_mobile"]');

    inputConteo.addEventListener("input", actualizarResumen);

    let selMotivoFirst = null;
    let motivoReadonly = null;
    if (idx === 0) {
      selMotivoFirst = el.querySelector('select[data-role="motivo-first-mobile"]');
      selMotivoFirst.value = motivoGlobal;
      selMotivoFirst.addEventListener("change", () => aplicarMotivoATodasLasFilas(selMotivoFirst.value));
    } else {
      motivoReadonly = el.querySelector('input[data-role="motivo-readonly-mobile"]');
    }

    return { el, inputStockAct, inputConteo, txtObs, selMotivoFirst, motivoReadonly };
  }

  function poblarResponsables() {
    $("responsable").innerHTML = RESPONSABLES_FIJOS.map(r => `<option value="${r}">${r}</option>`).join("");
    syncPrintResponsable();
    setStatus("Seleccion√° un responsable y hac√© clic en ¬´Cargar mis insumos¬ª.", "info");
  }

  function limpiarUI() {
    tbody.innerHTML = "";
    mobileList.innerHTML = "";
    for (const k of Object.keys(rowStore)) delete rowStore[k];
    actualizarResumen();
    setGuardarEnabled(false);
  }

  async function cargarPlan() {
    const responsable = $("responsable").value;
    syncPrintResponsable();

    limpiarUI();
    setStatus("Cargando insumos para " + responsable + "...", "info");

    try {
      const data = await apiPost(URL_PLAN, { responsable });
      let items = data.items || [];
      if (items.length && Array.isArray(items[0])) items = items[0];

      if (!items.length) {
        setStatus("No hay insumos pendientes para este responsable.", "err");
        return;
      }

      // construimos ambas vistas (tabla + cards) y las sincronizamos
      items.forEach((item, idx) => {
        const rowId = String(idx + 1);

        const baseTable = crearFilaTabla(item, idx, rowId);
        tbody.appendChild(baseTable.tr);

        const baseMobile = crearCardMobile(item, idx, rowId, baseTable);
        mobileList.appendChild(baseMobile.el);

        // Guardamos referencias para guardar / sync
        rowStore[rowId] = {
          rowId,
          tr: baseTable.tr,
          codigo: baseTable.codigo,
          descripcion: baseTable.descripcion,
          stock1030: baseTable.stock1030,
          stock1032: baseTable.stock1032,
          dia: baseTable.diaMostrar,

          inputStockActTable: baseTable.inputStockAct,
          inputConteoTable: baseTable.inputConteo,
          txtObsTable: baseTable.txtObs,
          selMotivoFirstTable: baseTable.selMotivoFirst,
          motivoReadonlyTable: baseTable.motivoReadonly,

          inputStockActMobile: baseMobile.inputStockAct,
          inputConteoMobile: baseMobile.inputConteo,
          txtObsMobile: baseMobile.txtObs,
          selMotivoFirstMobile: baseMobile.selMotivoFirst,
          motivoReadonlyMobile: baseMobile.motivoReadonly
        };

        // Sync inputs table <-> mobile (edites donde edites, queda igual)
        linkTwoInputs(baseTable.inputStockAct, baseMobile.inputStockAct, actualizarResumen);
        linkTwoInputs(baseTable.inputConteo,   baseMobile.inputConteo,   actualizarResumen);

        // Observaciones: sync (input event en textarea)
        baseTable.txtObs.addEventListener("input", () => baseMobile.txtObs.value = baseTable.txtObs.value);
        baseMobile.txtObs.addEventListener("input", () => baseTable.txtObs.value = baseMobile.txtObs.value);
      });

      aplicarMotivoATodasLasFilas(motivoGlobal);
      setGuardarEnabled(true);
      actualizarResumen();
      setStatus(`${items.length} insumos cargados. Complet√° los conteos y luego guard√°.`, "ok");

      // en mobile, scrollea al primer card (sensaci√≥n ‚Äúapp‚Äù)
      if (isMobileView()) {
        mobileList.firstElementChild?.scrollIntoView({ behavior: "smooth", block: "start" });
      }

    } catch (e) {
      console.error(e);
      setStatus("Error al cargar insumos: " + e.message, "err");
      setGuardarEnabled(false);
    }
  }

  async function guardarConteos() {
    const responsable = $("responsable").value;
    syncPrintResponsable();

    const conteos = [];

    for (const r of Object.values(rowStore)) {
      const fisicoStr = (r.inputConteoMobile?.value ?? r.inputConteoTable?.value ?? "").trim();
      if (fisicoStr === "") continue;

      const conteoFisico = Number(fisicoStr);
      if (!Number.isFinite(conteoFisico) || conteoFisico < 0) continue;

      const stockActualStr = (r.inputStockActMobile?.value ?? r.inputStockActTable?.value ?? "").trim();
      const stock1030Original = Number(r.stock1030 || 0);

      let stock1030Final = stock1030Original;
      if (stockActualStr !== "") {
        const n = Number(stockActualStr);
        if (Number.isFinite(n) && n >= 0) stock1030Final = n;
      }

      const obs = (r.txtObsMobile?.value ?? r.txtObsTable?.value ?? "");

      conteos.push({
        codigo: r.codigo,
        descripcion: r.descripcion,
        stock1030: stock1030Final,
        stock1030Original,
        stock1032: Number(r.stock1032 || 0),
        dia: r.dia,
        conteoFisico,
        motivo: motivoGlobal,
        observaciones: obs
      });
    }

    if (!conteos.length) {
      setStatus("No hay conteos cargados para guardar.", "err");
      return;
    }

    setStatus("Guardando conteos...", "info");
    setGuardarEnabled(false);

    try {
      await apiPost(URL_GUARDAR, { responsable, conteos });
      setStatus("Conteos guardados correctamente.", "ok");
    } catch (e) {
      console.error(e);
      setStatus("Error al guardar conteos: " + e.message, "err");
    } finally {
      setGuardarEnabled(true);
    }
  }

  // Eventos
  $("responsable").addEventListener("change", syncPrintResponsable);

  $("btnCargar").addEventListener("click", cargarPlan);
  $("btnGuardar").addEventListener("click", guardarConteos);

  $("btnCargarMobile").addEventListener("click", cargarPlan);
  $("btnGuardarMobile").addEventListener("click", guardarConteos);

  $("btnImprimir").addEventListener("click", () => {
    syncPrintResponsable();
    window.print();
  });

  poblarResponsables();
</script>
</body>
</html>
