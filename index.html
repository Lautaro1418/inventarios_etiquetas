<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventario Etiquetas</title>

  <style>
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      margin: 0;
      background: #f3f4f6;
      color: #111827;
    }

    .page {
      max-width: 1200px;
      margin: 24px auto 40px;
      padding: 0 16px;
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow:
        0 10px 15px -3px rgba(0,0,0,.08),
        0 4px 6px -4px rgba(0,0,0,.05);
      padding: 20px 20px 16px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 16px;
    }

    .title-block h1 {
      margin: 0 0 4px;
      font-size: 24px;
      font-weight: 700;
    }

    .title-block .sub {
      margin: 0;
      font-size: 13px;
      color: #6b7280;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #dbeafe;
      white-space: nowrap;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .toolbar-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      color: #4b5563;
    }

    select, input, textarea, button {
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 7px 10px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    select:focus,
    input:focus,
    textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
    }

    button {
      cursor: pointer;
      border: none;
      font-weight: 600;
      padding-inline: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    button span.icon {
      font-size: 14px;
    }

    #btnCargar {
      background: #2563eb;
      color: #ffffff;
    }

    #btnGuardar {
      background: #16a34a;
      color: #ffffff;
    }

    #btnImprimir {
      background: #6b7280;
      color: #ffffff;
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
    }

    #status {
      font-size: 13px;
      min-height: 18px;
    }

    #status.ok   { color: #16a34a; }
    #status.err  { color: #b91c1c; }
    #status.info { color: #4b5563; }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      display: inline-block;
      margin-right: 6px;
      background: #9ca3af;
    }
    #status.ok   .status-dot { background: #22c55e; }
    #status.err  .status-dot { background: #ef4444; }
    #status.info .status-dot { background: #9ca3af; }

    .hint {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }

    .table-shell {
      margin-top: 12px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
      background: #ffffff;
    }

    .table-wrapper {
      max-height: 60vh;
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: separate;     /* para divisiones tipo Excel */
      border-spacing: 0;
      font-size: 13px;
    }

    th, td {
      padding: 8px 8px;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
      background-clip: padding-box;
    }

    /* divisiones discretas entre columnas (estilo Excel) */
    th, td {
      border-right: 1px solid #edf2f7;
    }
    thead th:last-child,
    tbody td:last-child {
      border-right: none;
    }

    th {
      position: sticky;
      top: 0;
      z-index: 1;
      background: #f9fafb;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: #4b5563;
    }

    tbody tr:nth-child(odd)  td { background: #ffffff; }
    tbody tr:nth-child(even) td { background: #f9fafb; }
    tbody tr:hover td { background: #eef2ff; }

    input[type="number"] {
      width: 100%;
      text-align: right;
    }

    textarea {
      width: 100%;
      min-height: 36px;
      resize: vertical;
    }

    .summary {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-top: 1px solid #e5e7eb;
      font-size: 12px;
      color: #4b5563;
      background: #f9fafb;
    }

    .summary strong {
      font-weight: 700;
      color: #111827;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      button {
        justify-content: center;
        width: 100%;
      }
    }

    @media print {
      body { background: #ffffff; }
      .no-print { display: none !important; }
      .page { margin: 0; max-width: 100%; padding: 0; }
      .card { box-shadow: none; border-radius: 0; }
      .table-shell { border-radius: 0; border: none; }
      textarea { min-height: 60px; } /* m√°s espacio para escribir a mano */
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="card">
      <div class="header no-print">
        <div class="title-block">
          <h1>Inventario Etiquetas</h1>
          <!-- (sacado el texto que no quer√≠as) -->
        </div>
        <div class="badge">
          Paso 1: cargar listado ¬∑ Paso 2: contar ¬∑ Paso 3: guardar
        </div>
      </div>

      <div class="toolbar no-print">
        <div class="toolbar-group">
          <label for="responsable">Responsable del conteo</label>
          <select id="responsable"></select>
          <div class="hint">Eleg√≠ tu abreviatura y luego carg√° tus insumos.</div>
        </div>

        <div class="toolbar-group">
          <label>&nbsp;</label>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button id="btnCargar">
              <span class="icon">üì•</span><span>Cargar mis insumos</span>
            </button>
            <button id="btnGuardar" disabled>
              <span class="icon">üíæ</span><span>Guardar conteos</span>
            </button>
            <button id="btnImprimir">
              <span class="icon">üñ®Ô∏è</span><span>Imprimir listado</span>
            </button>
          </div>
        </div>

        <div class="toolbar-group" style="flex:1; min-width:180px;">
          <label>Estado</label>
          <div id="status" class="info">
            <span class="status-dot"></span>
            Preparado para empezar.
          </div>
        </div>
      </div>

      <div class="table-shell">
        <div class="table-wrapper">
          <table id="tabla">
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Descripci√≥n</th>
                <th>Stock 1030</th>
                <th>Stock 1032</th>
                <th>D√≠a stock</th>

                <!-- NUEVO -->
                <th>Stock 1030 ACTUAL</th>

                <th>Conteo f√≠sico</th>
                <th>Motivo</th>
                <th>Observaciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="summary no-print">
          <div>
            <strong id="totalInsumos">0</strong> insumos cargados ¬∑
            <strong id="totalCompletados">0</strong> con conteo cargado
          </div>
          <div class="hint">
            Consejo: complet√° solo las filas que realmente contaste.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ====== CONFIGURACI√ìN: URLs de tus Flows ======
  const URL_PLAN =
    "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/59b0d1d8c50c4277b875cb90c744d925/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=nTWG-VHLTpxBq_lVT8BwliveH9lxEFEcFhRisJDhd_g";

  const URL_GUARDAR =
    "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/db8f32640e3342199cad89ba5beca1a5/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=r_Y84605bC4pYKqpBNnQywaD3Qf5bY-jvVVBftQvkdU";

  const RESPONSABLES_FIJOS = ["JQ", "CG", "DF", "MF", "LS", "NM", "PM"];

  const $ = id => document.getElementById(id);
  const tbody = document.querySelector("#tabla tbody");

  // Motivo √∫nico (solo select en primera fila)
  let motivoGlobal = "Semanal";

  function setStatus(msg, type = "info") {
    const el = $("status");
    if (!el) return;
    el.textContent = "";
    el.className = type;
    const dot = document.createElement("span");
    dot.className = "status-dot";
    el.appendChild(dot);
    el.append(" " + msg);
  }

  function escapeHtml(str) {
    return String(str ?? "").replace(/[&<>"']/g, s =>
      ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[s])
    );
  }

  // Convierte n√∫mero de Excel o ISO a "dd/MM/yyyy HH:mm"
  function formatearDia(valor) {
    if (valor == null || valor === "") return "";

    if (/^\d{2}\/\d{2}\/\d{4}/.test(String(valor))) {
      return String(valor);
    }

    if (typeof valor === "number" || /^[0-9]+(\.[0-9]+)?$/.test(String(valor))) {
      const serial = Number(valor);
      if (!Number.isFinite(serial)) return String(valor);

      const days = Math.floor(serial);
      const frac = serial - days;

      const base = new Date(1899, 11, 30);
      base.setDate(base.getDate() + days);

      const minutesTotal = Math.round(frac * 24 * 60);
      const hours   = String(Math.floor(minutesTotal / 60)).padStart(2, "0");
      const minutes = String(minutesTotal % 60).padStart(2, "0");

      const year  = base.getFullYear();
      const month = String(base.getMonth() + 1).padStart(2, "0");
      const day   = String(base.getDate()).padStart(2, "0");

      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    const d = new Date(valor);
    if (!isNaN(d.getTime())) {
      const year  = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day   = String(d.getDate()).padStart(2, "0");
      const hours = String(d.getHours()).padStart(2, "0");
      const mins  = String(d.getMinutes()).padStart(2, "0");
      return `${day}/${month}/${year} ${hours}:${mins}`;
    }

    return String(valor);
  }

  async function apiPost(url, body) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify(body)
    });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = text; }
    if (!res.ok) {
      throw new Error(typeof data === "string" ? data : JSON.stringify(data));
    }
    return data;
  }

  function actualizarResumen() {
    const filas = Array.from(tbody.querySelectorAll("tr"));
    const total = filas.length;
    let completados = 0;

    filas.forEach(tr => {
      const v = tr.querySelector('input[data-field="conteo"]').value.trim();
      if (v !== "") completados++;
    });

    $("totalInsumos").textContent = total;
    $("totalCompletados").textContent = completados;
  }

  function aplicarMotivoATodasLasFilas(nuevoMotivo) {
    motivoGlobal = nuevoMotivo;
    tbody.querySelectorAll('select[data-role="motivo-row"]').forEach(sel => {
      sel.value = motivoGlobal;
    });
    tbody.querySelectorAll('input[data-role="motivo-readonly"]').forEach(inp => {
      inp.value = motivoGlobal;
    });
  }

  function crearFila(item, idx) {
    const descripcion =
      item.descripcion ??
      item["descripci√≥n"] ??
      "";
    const stock1030 =
      item.stock1030 ??
      item.stockJDE ??
      item["Stock 1030"] ??
      "";
    const stock1032 =
      item.stock1032 ??
      item["Stock 1032"] ??
      "";
    const diaMostrar = formatearDia(item.dia);

    const tr = document.createElement("tr");

    // Motivo: SOLO select en la primera fila. Las dem√°s readonly.
    const motivoCell = (idx === 0)
      ? `
        <select class="motivo-input" data-role="motivo-row">
          <option value="Semanal">Semanal</option>
          <option value="Administraci√≥n">Administraci√≥n</option>
        </select>
      `
      : `
        <input class="motivo-input" data-role="motivo-readonly" type="text" readonly value="${escapeHtml(motivoGlobal)}" />
      `;

    tr.innerHTML = `
      <td>${escapeHtml(item.codigo ?? "")}</td>
      <td>${escapeHtml(descripcion)}</td>
      <td style="text-align:right;">${escapeHtml(stock1030)}</td>
      <td style="text-align:right;">${escapeHtml(stock1032)}</td>
      <td>${escapeHtml(diaMostrar)}</td>

      <!-- NUEVO: Stock 1030 ACTUAL (vac√≠o por defecto) -->
      <td>
        <input type="number" min="0" step="1" placeholder="" data-field="stock1030_actual" />
      </td>

      <!-- Conteo f√≠sico: vac√≠o por defecto (sin 0) -->
      <td>
        <input type="number" min="0" step="1" placeholder="" data-field="conteo" />
      </td>

      <td>${motivoCell}</td>

      <!-- Observaciones: vac√≠o (sin placeholder que ocupe lugar en impresi√≥n) -->
      <td><textarea placeholder=""></textarea></td>
    `;

    tr.dataset.codigo = item.codigo ?? "";
    tr.dataset.descripcion = descripcion;
    tr.dataset.stock1030 = stock1030 ?? 0;
    tr.dataset.stock1032 = stock1032 ?? 0;
    tr.dataset.dia = diaMostrar;

    // Recalcular resumen cuando se escriba un conteo
    tr.querySelector('input[data-field="conteo"]').addEventListener("input", actualizarResumen);

    // Si cambian el motivo en la primera fila, se propaga
    if (idx === 0) {
      const sel = tr.querySelector('select[data-role="motivo-row"]');
      sel.value = motivoGlobal;
      sel.addEventListener("change", () => aplicarMotivoATodasLasFilas(sel.value));
    }

    // Asegura que las filas readonly reflejen el global al crearlas
    setTimeout(() => aplicarMotivoATodasLasFilas(motivoGlobal), 0);

    return tr;
  }

  function poblarResponsables() {
    $("responsable").innerHTML = RESPONSABLES_FIJOS
      .map(r => `<option value="${r}">${r}</option>`)
      .join("");
    setStatus("Seleccion√° un responsable y hac√© clic en ¬´Cargar mis insumos¬ª.", "info");
  }

  async function cargarPlan() {
    const responsable = $("responsable").value;
    tbody.innerHTML = "";
    actualizarResumen();
    $("btnGuardar").disabled = true;
    setStatus("Cargando insumos para " + responsable + "...", "info");

    try {
      const data = await apiPost(URL_PLAN, { responsable });
      let items = data.items || [];

      // Por si viene como [[{...}]]
      if (items.length && Array.isArray(items[0])) {
        items = items[0];
      }

      if (!items.length) {
        setStatus("No hay insumos pendientes para este responsable.", "err");
        return;
      }

      items.forEach((i, idx) => tbody.appendChild(crearFila(i, idx)));

      // aplicar motivo global una vez cargado
      aplicarMotivoATodasLasFilas(motivoGlobal);

      $("btnGuardar").disabled = false;
      actualizarResumen();
      setStatus(`${items.length} insumos cargados. Complet√° los conteos y luego guard√°.`, "ok");
    } catch (e) {
      console.error(e);
      setStatus("Error al cargar insumos: " + e.message, "err");
    }
  }

  async function guardarConteos() {
    const responsable = $("responsable").value;
    const filas = Array.from(tbody.querySelectorAll("tr"));
    const conteos = [];

    for (const tr of filas) {
      const fisicoStr = tr.querySelector('input[data-field="conteo"]').value.trim();
      if (fisicoStr === "") continue;

      const conteoFisico = Number(fisicoStr);
      if (!Number.isFinite(conteoFisico) || conteoFisico < 0) continue;

      // NUEVO: Stock 1030 ACTUAL si est√° cargado; si no, usar el original
      const stockActualStr = tr.querySelector('input[data-field="stock1030_actual"]').value.trim();
      const stock1030Original = Number(tr.dataset.stock1030 || 0);

      let stock1030Final = stock1030Original;
      if (stockActualStr !== "") {
        const n = Number(stockActualStr);
        if (Number.isFinite(n) && n >= 0) stock1030Final = n;
      }

      conteos.push({
        codigo: tr.dataset.codigo,
        descripcion: tr.dataset.descripcion,
        stock1030: stock1030Final,                 // <-- se devuelve el final
        stock1030Original: stock1030Original,       // (extra √∫til por auditor√≠a; pod√©s borrarlo si no quer√©s)
        stock1032: Number(tr.dataset.stock1032 || 0),
        dia: tr.dataset.dia,
        conteoFisico,
        motivo: motivoGlobal,                      // motivo √∫nico
        observaciones: tr.querySelector("textarea").value
      });
    }

    if (!conteos.length) {
      setStatus("No hay conteos cargados para guardar.", "err");
      return;
    }

    setStatus("Guardando conteos...", "info");
    $("btnGuardar").disabled = true;

    try {
      await apiPost(URL_GUARDAR, { responsable, conteos });
      setStatus("Conteos guardados correctamente.", "ok");
    } catch (e) {
      console.error(e);
      setStatus("Error al guardar conteos: " + e.message, "err");
    } finally {
      $("btnGuardar").disabled = false;
    }
  }

  $("btnCargar").addEventListener("click", cargarPlan);
  $("btnGuardar").addEventListener("click", guardarConteos);
  $("btnImprimir").addEventListener("click", () => window.print());

  poblarResponsables();
</script>
</body>
</html>
